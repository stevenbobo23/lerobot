# Release Notes

## [版本更新] - 2024年更新

### 🎯 主要功能

#### 1. 摄像头设备智能识别
- **新增功能**：支持通过设备名称自动查找摄像头设备路径
- **实现方式**：直接从 `/sys/class/video4linux/` 读取设备信息，无需依赖命令行工具
- **优势**：
  - 不依赖 `v4l-utils` 包
  - USB 设备序号变化时仍能正确识别
  - 支持通过设备名称（如 "USB Camera"、"T1 Webcam"）配置摄像头
- **相关文件**：`src/lerobot/robots/lekiwi/mcp/lekiwi_service.py`

#### 2. VIP 用户功能
- **新增路由**：`/vip` - VIP 用户专用入口
- **功能特性**：
  - VIP 用户可直接进入控制页面，无需等待排队
  - VIP 用户控制超时时间：10 分钟（普通用户 60 秒）
  - 自动替换当前活跃用户，优先获得控制权
- **相关文件**：`src/lerobot/robots/lekiwi/mcp/lekiwi_http_controller.py`

#### 3. 退出控制功能
- **新增功能**：用户可主动退出控制，释放控制权
- **实现方式**：
  - 在页面右上角添加"退出控制"按钮
  - 点击后清除当前活跃用户状态
  - 自动跳转到等待页面
- **相关文件**：
  - `src/lerobot/robots/lekiwi/mcp/lekiwi_http_controller.py`
  - `src/lerobot/robots/lekiwi/mcp/static/script.js`

### 🎨 用户界面改进

#### 1. 布局优化
- **摄像头区域**：调整到页面左侧，更符合视觉习惯
- **控制面板**：移至右侧，与摄像头区域并排显示
- **手势控制按钮**：
  - 文字改为"试试手势控制"
  - 使用渐变背景和更大尺寸，更加醒目
  - 独立区域显示，提升可见性

#### 2. 交互优化
- **移除通知提示**：去掉右上角的绿色成功/错误提示，界面更简洁
- **退出控制按钮**：在页面 header 右上角添加红色退出按钮，方便用户主动释放控制权

### 🤖 机械臂控制优化

#### 1. 关节范围调整
优化了各关节的运动范围，提升控制精度和安全性：

| 关节 | 原范围 | 新范围 | 说明 |
|------|--------|--------|------|
| 肩部水平 | -100~100 | **-60~60** | 减小范围，提升精度 |
| 肩部垂直 | -100~100 | **-55~55** | 减小范围，提升精度 |
| 肘关节 | -100~100 | **-50~50** | 减小范围，提升精度 |
| 腕关节弯曲 | -100~100 | **-70~70** | 减小范围，提升精度 |
| 腕关节旋转 | -100~100 | **-70~70** | 减小范围，提升精度 |
| 夹爪 | 0~100 | **0~60** | 减小范围，提升精度 |

#### 2. 夹爪性能优化
- **响应速度提升**：将夹爪平滑因子从 `0.5` 提升到 `0.8`
- **效果**：夹爪闭合/张开响应更快，操作更流畅

#### 3. 自动复位功能
- **页面加载时**：每次进入控制页面时自动执行机械臂复位
- **手势控制启动时**：开启手势控制前自动执行复位
- **优势**：确保机械臂始终处于安全的初始状态

### 🔧 技术改进

#### 1. 摄像头设备查找
- **优化前**：使用 `v4l2-ctl --list-devices` 命令行工具
- **优化后**：直接从 `/sys/class/video4linux/video*/name` 读取设备名称
- **优势**：
  - 无需外部依赖
  - 更快的响应速度
  - 更可靠的设备识别

#### 2. 代码优化
- 移除未使用的导入和变量
- 优化错误处理和日志记录
- 改进代码结构和可维护性

### 📝 文件变更清单

#### 核心功能文件
- `src/lerobot/robots/lekiwi/mcp/lekiwi_service.py`
  - 新增 `find_camera_by_name()` 函数
  - 更新 `create_default_service()` 支持设备名称查找

- `src/lerobot/robots/lekiwi/mcp/lekiwi_http_controller.py`
  - 新增 `/vip` 路由
  - 新增 `/exit_control` 路由
  - 更新会话管理逻辑支持 VIP 用户

#### 前端界面文件
- `src/lerobot/robots/lekiwi/mcp/templates/index.html`
  - 调整页面布局（摄像头靠左）
  - 更新手势控制按钮样式
  - 添加退出控制按钮
  - 更新所有关节滑块范围

- `src/lerobot/robots/lekiwi/mcp/static/script.js`
  - 添加 `exitControl()` 函数
  - 添加页面加载时自动复位
  - 禁用通知提示功能

- `src/lerobot/robots/lekiwi/mcp/static/gesture_control.js`
  - 更新关节范围定义
  - 优化夹爪响应速度
  - 添加手势控制启动时自动复位

### 🐛 Bug 修复

- 修复摄像头设备序号变化导致的识别问题
- 优化设备查找的错误处理逻辑

### ⚠️ 注意事项

1. **摄像头设备名称**：确保系统能够正确识别设备名称（"USB Camera" 和 "T1 Webcam"）
2. **VIP 功能**：VIP 用户会直接替换当前活跃用户，请谨慎使用
3. **关节范围**：新的关节范围更小，请根据实际需求调整控制参数

### 🔄 向后兼容性

- 所有改动保持向后兼容
- 如果设备名称查找失败，会自动回退到默认路径
- 普通用户功能不受影响

---

**更新日期**：2024年  
**版本**：v1.x.x

